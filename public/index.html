<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure LAN Chat Ultra</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --bg-color: #121212;
            --chat-bg: #1e1e1e;
            --accent: #00e676;
            --text-main: #ffffff;
            --incoming: #2a2a2a;
        }
        * { box-sizing: border-box; }
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- SETUP SCREEN --- */
        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        input {
            background: var(--chat-bg); border: 1px solid #333; padding: 15px;
            color: white; border-radius: 10px; width: 300px; margin-bottom: 10px;
            outline: none;
        }
        .btn-primary {
            background: var(--accent); border: none; padding: 15px 40px;
            border-radius: 30px; font-weight: bold; cursor: pointer;
        }

        /* --- CHAT UI --- */
        #chat-ui { display: none; flex-direction: column; height: 100%; }
        header {
            padding: 15px; background: rgba(30,30,30,0.95);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333;
        }
        .btn-leave { background: #ff4444; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer;}

        #messages {
            flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px;
        }

        /* --- MESSAGE BUBBLES --- */
        .message {
            max-width: 85%; padding: 10px 15px; border-radius: 18px;
            font-size: 0.95rem; position: relative; word-wrap: break-word;
            animation: popIn 0.2s ease;
        }
        .message.sent { align-self: flex-end; background-color: var(--accent); color: black; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background-color: var(--incoming); color: white; border-bottom-left-radius: 2px; }
        
        .meta { font-size: 0.7rem; opacity: 0.7; margin-bottom: 5px; display: block;}
        .delete-btn {
            position: absolute; top: -8px; right: -8px; background: #ff4444; color: white;
            width: 20px; height: 20px; border-radius: 50%; border: none; cursor: pointer;
            font-size: 12px; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* --- MEDIA STYLES --- */
        .chat-img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer;}
        audio { height: 35px; max-width: 200px; margin-top: 5px; }
        
        /* --- INPUT AREA --- */
        #typing-indicator { height: 20px; padding: 0 20px; font-size: 0.7rem; color: #888; opacity: 0; transition: opacity 0.3s; }
        #input-area {
            padding: 10px; background: var(--chat-bg); display: flex; align-items: center; gap: 8px;
        }
        #msg-input { flex: 1; background: #121212; border: none; margin: 0; }
        .icon-btn {
            background: none; border: none; color: var(--accent); cursor: pointer; padding: 5px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn.recording { color: #ff4444; animation: pulse 1s infinite; }

        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="setup-screen">
        <h1 style="color:var(--accent)">LAN Chat <span style="font-size:0.5em; color:#666">v4.0</span></h1>
        <p id="network-status" style="color:#666; font-family:monospace; margin-bottom: 20px;">Detecting Network...</p>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="room-key" placeholder="Room Name (Secret)">
        <button class="btn-primary" onclick="joinChat()">Join Securely</button>
    </div>

    <div id="chat-ui">
        <header>
            <div style="display:flex; flex-direction:column;">
                <span id="display-name" style="font-weight:bold;">User</span>
                <span id="room-name" style="font-size:0.7rem; color:#aaa;">Room: ...</span>
            </div>
            <button class="btn-leave" onclick="location.reload()">Leave</button>
        </header>

        <div id="messages"></div>
        <div id="typing-indicator">Typing...</div>

        <div id="input-area">
            <input type="file" id="img-upload" hidden accept="image/*" onchange="handleImage(this)">
            <button class="icon-btn" onclick="document.getElementById('img-upload').click()">
                <span class="material-icons">image</span>
            </button>

            <button class="icon-btn" id="mic-btn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">
                <span class="material-icons">mic</span>
            </button>

            <input id="msg-input" placeholder="Message..." autocomplete="off">
            <button class="icon-btn" onclick="sendText()">
                <span class="material-icons">send</span>
            </button>
        </div>
    </div>

    <audio id="notify-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

    <script>
        const socket = io();
        let username = 'Anon';
        let roomId = '';
        let subnet = '';
        let mediaRecorder;
        let audioChunks = [];

        // --- 1. NETWORK DETECTION ---
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => {
                const parts = data.ip.split('.');
                parts.pop(); // Remove last octet
                subnet = parts.join('.');
                document.getElementById('network-status').innerText = `Network ID: ${subnet}.x`;
                document.getElementById('network-status').style.color = '#00e676';
            });

        // --- 2. JOIN LOGIC ---
        function joinChat() {
            const userIn = document.getElementById('username').value.trim();
            const roomIn = document.getElementById('room-key').value.trim();
            if (!roomIn || !subnet) return alert("Wait for network or enter room name");

            username = userIn || 'Anon';
            roomId = `${subnet}-${roomIn}`; // Security Lock

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('chat-ui').style.display = 'flex';
            document.getElementById('display-name').innerText = username;
            document.getElementById('room-name').innerText = `Room: ${roomIn}`;

            socket.emit('join_room', { username, room: roomId });
        }

        // --- 3. SENDING MESSAGES ---
        function sendPayload(content, type) {
            const key = document.getElementById('room-key').value;
            const uniqueId = Date.now() + Math.random().toString(16).slice(2); // Unique ID for deletion

            // Encrypt Content
            const encrypted = CryptoJS.AES.encrypt(content, key).toString();

            const data = {
                id: uniqueId,
                room: roomId,
                user: username,
                content: encrypted,
                type: type, // 'text', 'image', 'audio'
                timestamp: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            };

            socket.emit('chat_message', data);
            renderMessage(data, 'sent', content); // Show locally
        }

        function sendText() {
            const input = document.getElementById('msg-input');
            if (input.value.trim()) {
                sendPayload(input.value.trim(), 'text');
                input.value = '';
            }
        }

        // --- 4. IMAGE HANDLING ---
        function handleImage(input) {
            const file = input.files[0];
            if (file && file.size < 5000000) { // 5MB Limit
                const reader = new FileReader();
                reader.onload = (e) => sendPayload(e.target.result, 'image');
                reader.readAsDataURL(file);
            } else { alert("Image too large (Max 5MB)"); }
        }

        // --- 5. VOICE NOTES ---
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                document.getElementById('mic-btn').classList.add('recording');

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    document.getElementById('mic-btn').classList.remove('recording');
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' }); // webm is standard for web audio
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => sendPayload(reader.result, 'audio');
                };

                mediaRecorder.start();
            } catch (err) { alert("Microphone access denied"); }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        }

        // --- 6. DELETION LOGIC ---
        function deleteMessage(msgId) {
            if(confirm("Delete this message for everyone?")) {
                socket.emit('delete_message', { room: roomId, id: msgId });
                removeMessageFromUI(msgId);
            }
        }

        socket.on('delete_message', (id) => removeMessageFromUI(id));

        function removeMessageFromUI(id) {
            const el = document.getElementById(id);
            if (el) {
                el.style.opacity = '0';
                setTimeout(() => el.remove(), 300); // Animation
            }
        }

        // --- 7. RECEIVING & RENDERING ---
        socket.on('chat_message', (data) => {
            const key = document.getElementById('room-key').value;
            try {
                const decrypted = CryptoJS.AES.decrypt(data.content, key).toString(CryptoJS.enc.Utf8);
                if (decrypted) {
                    renderMessage(data, 'received', decrypted);
                    document.getElementById('notify-sound').play().catch(()=>{});
                }
            } catch (e) {}
        });

        function renderMessage(data, type, content) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.id = data.id; // Assign ID for deletion

            let innerHTML = `<span class="meta">${data.user} • ${data.timestamp}</span>`;

            // Content Type Logic
            if (data.type === 'text') innerHTML += `<span>${content}</span>`;
            else if (data.type === 'image') innerHTML += `<img src="${content}" class="chat-img" onclick="window.open(this.src)">`;
            else if (data.type === 'audio') innerHTML += `<audio controls src="${content}"></audio>`;

            // Add Delete Button if it's MY message
            if (type === 'sent') {
                innerHTML += `<button class="delete-btn" onclick="deleteMessage('${data.id}')">×</button>`;
            }

            div.innerHTML = innerHTML;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        // --- 8. TYPING INDICATOR ---
        const inputField = document.getElementById('msg-input');
        inputField.addEventListener('input', () => socket.emit('typing', { room: roomId, user: username }));

        let typingTimer;
        socket.on('typing', (data) => {
            const ind = document.getElementById('typing-indicator');
            ind.innerText = `${data.user} is typing...`;
            ind.style.opacity = 1;
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => ind.style.opacity = 0, 1000);
        });
        
        // Enter to send
        inputField.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendText() });
    </script>
</body>
</html>